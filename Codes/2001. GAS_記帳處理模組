// 記帳處理模組 v1_0_1_Chatty

function processTestData() {
  // 1. 定義 Google Sheet
  var testSheet = SpreadsheetApp.openById("1TSn-X-8B_PDUseZZPbbc0AhK55E80DBXJqkPRtStOUY").getSheetByName("測試記帳數據");
  var mainSheet = SpreadsheetApp.openById("1TSn-X-8B_PDUseZZPbbc0AhK55E80DBXJqkPRtStOUY").getSheetByName("01. 總帳");
  
  // 2. 取得最後一筆測試數據
  var lastRow = testSheet.getLastRow();
  var testData = testSheet.getRange(lastRow, 1, 1, 7).getValues()[0];
  console.log("[DEBUG] 讀取測試數據:", testData);
  
  // 3. 解析測試數據
  var transactionDate = testData[0];
  var transactionTime = testData[1];
  var categoryCode = testData[2];
  var amount = testData[3];
  var paymentType = testData[4];
  var userId = testData[5];
  var remark = testData[6] || "";
  
  // 4. 產生收支 ID
  var date = new Date();
  var dateString = Utilities.formatDate(date, Session.getScriptTimeZone(), "yyyyMMdd");
  var lastMainRow = mainSheet.getLastRow();
  var nextId = lastMainRow > 1 ? parseInt(mainSheet.getRange(lastMainRow, 1).getValue().split("-")[1]) + 1 : 1;
  var formattedId = dateString + "-" + ("00000" + nextId).slice(-5);
  console.log("[DEBUG] 產生的收支ID:", formattedId);
  
  // 5. 查找科目名稱與大項
  var categorySheet = SpreadsheetApp.openById("1TSn-X-8B_PDUseZZPbbc0AhK55E80DBXJqkPRtStOUY").getSheetByName("00. 科目代碼");
  var categoryData = categorySheet.getDataRange().getValues();
  var categoryName = "未知科目";
  var majorCategory = "未知大項";
  
  for (var i = 1; i < categoryData.length; i++) {
    if (categoryData[i][0] == categoryCode) {
      categoryName = categoryData[i][1];
      majorCategory = categoryCode.substring(0, 3);
      break;
    }
  }
  console.log("[DEBUG] 科目名稱:", categoryName, "| 科目大項:", majorCategory);
  
  // 6. 判斷收入或支出
  var income = paymentType === "收入" ? amount : "";
  var expense = paymentType === "支出" ? amount : "";
  
  // 7. 寫入 Google Sheet
  mainSheet.appendRow([formattedId, transactionDate, transactionTime, majorCategory, categoryCode, paymentType, categoryName, userId, remark, income, expense]);
  console.log("[DEBUG] 記帳成功，寫入資料:", formattedId, transactionDate, transactionTime, majorCategory, categoryCode, paymentType, categoryName, userId, remark, income, expense);
}
