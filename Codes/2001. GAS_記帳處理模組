function 記帳處理模組_1_0_0_Chatty(event) {
  Logger.log("1. 接收 LINE Chatbot 傳入的 event 參數: %s", JSON.stringify(event));
  
  // 2. 解析 LINE 傳入的資料
  var userId = event.source.userId;
  var messageText = event.message.text;
  var messageArray = messageText.split(" ");
  
  if (messageArray.length < 5) {
    Logger.log("錯誤: 傳入的資料格式不正確: %s", messageText);
    return "格式錯誤，請輸入：日期 時間 科目代碼 費用種類 金額 [備註]";
  }
  
  var date = messageArray[0]; // YYYY/MM/DD
  var time = messageArray[1]; // HH:mm
  var subjectCode = messageArray[2]; // 科目代碼 (5碼)
  var paymentType = messageArray[3]; // 費用種類 (刷卡/現金)
  var amount = parseFloat(messageArray[4]); // 金額
  var remark = messageArray.length > 5 ? messageArray.slice(5).join(" ") : "";
  
  // 3. 取得 Google Sheet
  var sheetId = "1TSn-X-8B_PDUseZZPbbc0AhK55E80DBXJqkPRtStOUY";
  var sheet = SpreadsheetApp.openById(sheetId).getSheetByName("01. 總帳");
  
  // 4. 取得當天最後一筆流水號
  var lastRow = sheet.getLastRow();
  var newId = generateTransactionId(date, sheet, lastRow);
  
  // 5. 取得科目大項與名稱
  var subjectData = getSubjectData(subjectCode);
  if (!subjectData) {
    Logger.log("錯誤: 科目代碼 %s 不存在", subjectCode);
    return "錯誤：無效的科目代碼，請確認後重新輸入";
  }
  
  var income = amount > 0 ? amount : "";
  var expense = amount < 0 ? -amount : "";
  
  // 6. 寫入 Google Sheet
  sheet.appendRow([newId, date, time, subjectData.major, subjectCode, paymentType, subjectData.name, userId, remark, income, expense]);
  Logger.log("成功寫入 Google Sheet: %s", newId);
  
  return "記帳成功！收支ID: " + newId;
}

/** 取得科目大項與名稱 */
function getSubjectData(subjectCode) {
  var sheetId = "1TSn-X-8B_PDUseZZPbbc0AhK55E80DBXJqkPRtStOUY";
  var sheet = SpreadsheetApp.openById(sheetId).getSheetByName("00. 科目代碼");
  var data = sheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] == subjectCode) {
      return { major: subjectCode.substring(0, 3), name: data[i][1] };
    }
  }
  return null;
}

/** 生成收支ID */
function generateTransactionId(date, sheet, lastRow) {
  var dateStr = date.replace(/\//g, "");
  var count = 1;
  if (lastRow > 1) {
    var lastId = sheet.getRange(lastRow, 1).getValue();
    if (lastId.startsWith(dateStr)) {
      count = parseInt(lastId.split("-")[1]) + 1;
    }
  }
  return dateStr + "-" + ("00000" + count).slice(-5);
}
