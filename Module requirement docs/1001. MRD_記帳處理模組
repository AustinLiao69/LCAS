// 記帳處理模組 v1_0_0_Chatty

function doPost(e) {
  // 1. 解析接收到的 JSON 數據
  var requestData = JSON.parse(e.postData.contents);
  console.log("[DEBUG] 接收到的數據:", requestData);

  // 2. 定義 Google Sheet
  var sheet = SpreadsheetApp.openById("1TSn-X-8B_PDUseZZPbbc0AhK55E80DBXJqkPRtStOUY").getSheetByName("01. 總帳");

  // 3. 產生收支 ID
  var date = new Date();
  var dateString = Utilities.formatDate(date, Session.getScriptTimeZone(), "yyyyMMdd");
  var lastRow = sheet.getLastRow();
  var nextId = lastRow > 1 ? parseInt(sheet.getRange(lastRow, 1).getValue().split("-")[1]) + 1 : 1;
  var formattedId = dateString + "-" + ("00000" + nextId).slice(-5);
  console.log("[DEBUG] 產生的收支ID:", formattedId);

  // 4. 取得 LINE 傳入的資料
  var transactionDate = requestData.date;
  var transactionTime = requestData.time;
  var categoryCode = requestData.category_code;
  var amount = requestData.amount;
  var paymentType = requestData.payment_type;
  var userId = requestData.user_id;
  var remark = requestData.remark || "";

  // 5. 驗證輸入數據
  if (!transactionDate || !transactionTime || !categoryCode || !amount || !userId) {
    console.log("[DEBUG] 數據驗證失敗，缺少必要欄位");
    return ContentService.createTextOutput("ERROR: 缺少必要欄位").setMimeType(ContentService.MimeType.TEXT);
  }

  // 6. 查找科目大項
  var categorySheet = SpreadsheetApp.openById("1TSn-X-8B_PDUseZZPbbc0AhK55E80DBXJqkPRtStOUY").getSheetByName("00. 科目代碼");
  var categoryData = categorySheet.getDataRange().getValues();
  var categoryName = "未知科目";
  var majorCategory = "未知大項";

  for (var i = 1; i < categoryData.length; i++) {
    if (categoryData[i][0] == categoryCode) {
      categoryName = categoryData[i][1];
      majorCategory = categoryCode.substring(0, 3);
      break;
    }
  }
  console.log("[DEBUG] 科目名稱:", categoryName, "| 科目大項:", majorCategory);

  // 7. 判斷收入或支出
  var income = paymentType === "收入" ? amount : "";
  var expense = paymentType === "支出" ? amount : "";

  // 8. 寫入 Google Sheet
  sheet.appendRow([formattedId, transactionDate, transactionTime, majorCategory, categoryCode, paymentType, categoryName, userId, remark, income, expense]);
  console.log("[DEBUG] 記帳成功，寫入資料:", formattedId, transactionDate, transactionTime, majorCategory, categoryCode, paymentType, categoryName, userId, remark, income, expense);

  return ContentService.createTextOutput("SUCCESS").setMimeType(ContentService.MimeType.TEXT);
}
